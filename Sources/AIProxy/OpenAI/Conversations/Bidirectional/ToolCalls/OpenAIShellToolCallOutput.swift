//
//  OpenAIShellToolCallOutput.swift
//  AIProxy
//
//  Created by Lou Zell on 12/21/25.
//
// OpenAI Guide: https://platform.openai.com/docs/guides/tools-shell
// The guide has the concept of a "shell_call output", which is *not* this type.
// When OpenAI says "shell_call output", they mean the response from the OpenAIShellToolCall request.
// This type respresents the output that the shell call creates.
// We are responsible for passing the output of the shell call back to OpenAI.
//
// OpenAPI spec: FunctionShellCallOutputItemParam, version 2.3.0, line 66051
// Encodable: https://platform.openai.com/docs/api-reference/conversations/create#conversations_create-items-item-shell_tool_call_output
// Decodable: https://platform.openai.com/docs/api-reference/conversations/list-items-object#conversations-list_items_object-data-shell_call_output

/// The streamed output items emitted by a shell tool call.
nonisolated public struct OpenAIShellToolCallOutput: Codable, Sendable {
    /// The unique ID of the shell tool call generated by the model.
    public let callID: String

    /// The unique ID of the shell tool call output. Populated when this item is returned via API.
    public let id: String

    /// The maximum number of UTF-8 characters captured for this shell call's combined output.
    public let maxOutputLength: Int

    /// Captured chunks of stdout and stderr output, along with their associated outcomes.
    public let output: [Output]

    /// The type of the item. Always `shell_call_output`.
    public let type = "shell_call_output"

    /// Creates a new shell tool call output item parameter.
    /// - Parameters:
    ///   - callID: The unique ID of the shell tool call generated by the model.
    ///   - id: The unique ID of the shell tool call output.
    ///   - maxOutputLength: The maximum number of UTF-8 characters captured for this shell call's combined output.
    ///   - output: Captured chunks of stdout and stderr output, along with their associated outcomes.
    public init(
        callID: String,
        id: String,
        maxOutputLength: Int,
        output: [OpenAIShellToolCallOutput.Output]
    ) {
        self.callID = callID
        self.id = id
        self.maxOutputLength = maxOutputLength
        self.output = output
    }

    private enum CodingKeys: String, CodingKey {
        case callID = "call_id"
        case output
        case type
        case id
        case maxOutputLength = "max_output_length"
    }

    public func encode(to encoder: Encoder) throws {
        var container = encoder.container(keyedBy: CodingKeys.self)
        try container.encode(callID, forKey: .callID)
        try container.encode(output, forKey: .output)
        try container.encode(type, forKey: .type)
        try container.encode(id, forKey: .id)
        try container.encode(maxOutputLength, forKey: .maxOutputLength)
    }
}

extension OpenAIShellToolCallOutput {
    // OpenAPI spec: FunctionShellCallOutputContent, version 2.3.0, line 65489
    /// Captured stdout and stderr for a portion of a shell tool call output.
    nonisolated public struct Output: Codable, Sendable {
        /// The exit or timeout outcome associated with this shell call.
        public let outcome: OpenAIShellToolCallOutcome

        /// Captured stderr output for the shell call.
        public let stderr: String

        /// Captured stdout output for the shell call.
        public let stdout: String

        /// Creates a new shell output content parameter.
        /// - Parameters:
        ///   - outcome: The exit or timeout outcome associated with this shell call.
        ///   - stderr: Captured stderr output for the shell call.
        ///   - stdout: Captured stdout output for the shell call.
        public init(
            outcome: OpenAIShellToolCallOutcome,
            stderr: String,
            stdout: String
        ) {
            self.outcome = outcome
            self.stderr = stderr
            self.stdout = stdout
        }

        private enum CodingKeys: String, CodingKey {
            case outcome
            case stderr
            case stdout
        }

        public func encode(to encoder: Encoder) throws {
            var container = encoder.container(keyedBy: CodingKeys.self)
            try container.encode(outcome, forKey: .outcome)
            try container.encode(stderr, forKey: .stderr)
            try container.encode(stdout, forKey: .stdout)
        }
    }
}
